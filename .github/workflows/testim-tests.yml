name: Run Testim Tests

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch: # Allows manual triggering from GitHub UI

jobs:
  testim-tests:
    name: Run Testim Automated Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install Testim CLI
        run: npm install -g @testim/testim-cli
      
      - name: Verify Testim CLI installation
        run: testim --version
      
      - name: Run Testim Tests
        id: run-tests
        env:
          TESTIM_PROJECT_ID: ${{ secrets.TESTIM_PROJECT_ID }}
          TESTIM_API_TOKEN: ${{ secrets.TESTIM_API_TOKEN }}
          TESTIM_GRID: ${{ secrets.TESTIM_GRID }}
        run: |
          echo "üöÄ Starting Testim test execution..."
          
          # Validate required secrets
          if [ -z "$TESTIM_PROJECT_ID" ]; then
            echo "‚ùå ERROR: TESTIM_PROJECT_ID secret is not set"
            exit 1
          fi
          
          if [ -z "$TESTIM_API_TOKEN" ]; then
            echo "‚ùå ERROR: TESTIM_API_TOKEN secret is not set"
            exit 1
          fi
          
          echo "Project ID: ${TESTIM_PROJECT_ID:0:10}..." # Show first 10 chars for logging
          echo "Token: ${TESTIM_API_TOKEN:0:10}..." # Show first 10 chars for verification
          
          # Run all tests in the project
          # Testim CLI requires --grid, --grid-id, or --host parameter
          if [ -n "$TESTIM_GRID" ]; then
            GRID_PARAM="--grid $TESTIM_GRID"
            echo "Using grid: $TESTIM_GRID"
          else
            # Use default cloud grid if not specified
            echo "‚ö†Ô∏è TESTIM_GRID not set, using default cloud grid"
            GRID_PARAM="--grid cloud"
          fi
          
          echo "Executing Testim CLI command..."
          testim \
            --token "$TESTIM_API_TOKEN" \
            --project "$TESTIM_PROJECT_ID" \
            $GRID_PARAM || TEST_EXIT_CODE=$?
          
          # Create output directory if it doesn't exist
          mkdir -p ./testim-results
          
          # Exit with the test result code
          exit ${TEST_EXIT_CODE:-0}
        continue-on-error: true
      
      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: testim-test-results
          path: |
            testim-results/
            *.xml
            *.json
          retention-days: 30
          if-no-files-found: warn
      
      - name: Publish Test Results Summary
        if: always()
        run: |
          echo "## üìä Testim Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -d "testim-results" ]; then
            echo "‚úÖ Test results available in artifacts" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the 'testim-test-results' artifact for detailed results." >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è No test results found" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.run-tests.outcome }}" == "success" ]; then
            echo "‚úÖ All tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå Some tests failed. Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Comment PR with Test Results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            
            let comment = '## ü§ñ Testim Test Results\n\n';
            
            if (fs.existsSync('testim-results')) {
              comment += '‚úÖ Tests completed. Check artifacts for detailed results.\n\n';
            } else {
              comment += '‚ö†Ô∏è Test results not available.\n\n';
            }
            
            const testOutcome = '${{ steps.run-tests.outcome }}';
            comment += `**Status**: ${testOutcome === 'success' ? '‚úÖ Passed' : '‚ùå Failed'}\n\n`;
            comment += 'View full results in the workflow run artifacts.';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
